name: Build Connect IQ App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Connect IQ SDK
      run: |
        echo "ðŸ“¦ Downloading Connect IQ SDK..."
        # Download latest SDK (7.x)
        wget -q https://developer.garmin.com/downloads/connect-iq/sdks/connectiq-sdk-lin-7.3.1-2024-09-28-f40435dff.zip -O sdk.zip
        unzip -q sdk.zip -d connectiq-sdk
        export PATH=$PWD/connectiq-sdk/bin:$PATH
        
        echo "ðŸ“‹ Available devices:"
        ls connectiq-sdk/Devices/ | grep -i edge | head -20
        
    - name: Build App
      run: |
        export PATH=$PWD/connectiq-sdk/bin:$PATH
        
        # Create output directory
        mkdir -p output
        
        # Create icon (40x40 for edge1040)
        sudo apt-get update && sudo apt-get install -y imagemagick
        convert -size 40x40 xc:#22AA22 \
          -fill white -gravity center -pointsize 14 -annotate +0+0 "AS" \
          resources/drawables/launcher_icon.png
        
        # Generate developer key
        echo "ðŸ”‘ Generating developer key..."
        openssl genrsa -out developer_key.pem 4096 2>/dev/null
        openssl pkcs8 -topk8 -inform PEM -outform DER \
          -in developer_key.pem -out developer_key.der -nocrypt
        
        echo "ðŸ”¨ Building Approach Speed for Edge 1040..."
        monkeyc \
          -d edge1040 \
          -f monkey.jungle \
          -o "output/ApproachSpeed-edge1040.prg" \
          -y developer_key.der \
          -w 2>&1 || true
        
        # Check what was built
        echo "ðŸ“¦ Build results:"
        ls -la output/*.prg 2>/dev/null || echo "No PRG files"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: approach-speed-prg
        path: output/*.prg
        if-no-files-found: error
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: "*.prg"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
