name: Build Connect IQ App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build using Docker
      run: |
        echo "ðŸ³ Building with Connect IQ Docker image..."
        
        # Create output directory
        mkdir -p output
        
        # Create icon (60x60 for edge1040)
        sudo apt-get update && sudo apt-get install -y imagemagick
        convert -size 60x60 xc:#22AA22 \
          -fill white -gravity center -pointsize 20 -annotate +0+0 "AS" \
          resources/drawables/launcher_icon.png
        
        # Generate key BEFORE Docker (with proper permissions)
        echo "ðŸ”‘ Generating developer key..."
        openssl genrsa -out developer_key.pem 4096 2>/dev/null
        openssl pkcs8 -topk8 -inform PEM -outform DER \
          -in developer_key.pem -out developer_key.der -nocrypt
        chmod 644 developer_key.der developer_key.pem
        
        # Run build in Docker container (piccobit has SDK 4.1.7 with edge1040)
        docker run --rm \
          -v "$PWD:/workspace" \
          -w /workspace \
          -u $(id -u):$(id -g) \
          piccobit/docker-connectiq:4.1.7-2022-11-21-562b8a195 \
          bash -c '
            export PATH=$PATH:/opt/ciq/bin
            echo "ðŸ”¨ Building Approach Speed..."
            
            # Build for Edge 1040
            echo "Building for edge1040..."
            monkeyc \
              -d edge1040 \
              -f monkey.jungle \
              -o "output/ApproachSpeed-edge1040.prg" \
              -y developer_key.der \
              -w 2>&1
            
            ls -la output/*.prg 2>/dev/null || echo "âŒ No PRG files created"
          '
        
        # Check what was built
        echo "ðŸ“¦ Build results:"
        ls -la output/*.prg 2>/dev/null || echo "No PRG files"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: approach-speed-prg
        path: output/*.prg
        if-no-files-found: error
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: "*.prg"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
