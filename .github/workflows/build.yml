name: Build Connect IQ App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build using Docker
      run: |
        echo "ðŸ³ Building with Connect IQ Docker image..."
        
        # Create output directory
        mkdir -p output
        
        # Generate developer key
        openssl genrsa -out developer_key.pem 4096
        openssl pkcs8 -topk8 -inform PEM -outform DER \
          -in developer_key.pem -out developer_key.der -nocrypt
        
        # Create proper 60x60 icon
        sudo apt-get update && sudo apt-get install -y imagemagick
        convert -size 60x60 xc:#22AA22 \
          -fill white -gravity center -pointsize 20 -annotate +0+0 "AS" \
          resources/drawables/launcher_icon.png
        
        # Run build in Docker container
        docker run --rm \
          -v "$PWD:/workspace" \
          -w /workspace \
          kalemena/connectiq:latest \
          bash -c '
            export PATH=$PATH:/opt/ciq/bin
            echo "ðŸ”¨ Building Approach Speed..."
            
            # Build for available devices
            for device in edge1040 edge530 edge830 edge1030 edge540 edge840; do
              echo "Building for $device..."
              monkeyc \
                -d $device \
                -f monkey.jungle \
                -o "output/ApproachSpeed-${device}.prg" \
                -y developer_key.der \
                2>&1 || echo "âš ï¸ $device not available"
            done
            
            ls -la output/*.prg 2>/dev/null || echo "Checking output..."
          '
        
        # Check what was built
        echo "ðŸ“¦ Build results:"
        ls -la output/*.prg 2>/dev/null || ls -la *.prg 2>/dev/null || echo "No PRG files"
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: approach-speed-builds
        path: |
          output/*.prg
          *.prg
        if-no-files-found: warn
        retention-days: 30
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: approach-speed-builds
        path: "*.prg"
        if-no-files-found: warn
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: "*.prg"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
